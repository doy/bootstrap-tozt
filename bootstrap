#!/usr/bin/env bash
set -eux
set -o pipefail

host="$1"

remote() {
    ssh root@$host "$@"
}

if remote test ! -e /usr/bin/pacman; then
    remote apt-get -y update
    remote apt-get -y install git
    remote "cd /tmp && git clone git://github.com/doy/bootstrap-tozt"
    remote "cd /tmp/bootstrap-tozt && git submodule update --init"
    remote "cd /tmp/bootstrap-tozt/digitalocean-debian-to-arch && bash install.sh --i_understand_that_this_droplet_will_be_completely_wiped"
    sleep 30
fi

remote pacman --noconfirm -Sy
remote pacman --noconfirm --needed -S puppet git ruby-shadow

if remote test -d /tmp/bootstrap-tozt; then
    remote "cd /tmp/bootstrap-tozt && git pull"
else
    remote "cd /tmp && git clone git://github.com/doy/bootstrap-tozt"
fi

remote "cd /tmp/bootstrap-tozt && puppet apply --modulepath=./modules manifest.pp"
